/* ogre.js - MIT Licensed - http://github.com/elucidata/ogre.js */
(function(){var n,t,r,e,u,l,o,i,s,a,c,h=[].indexOf||function(n){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===n)return t;return-1};"undefined"!=typeof require&&null!==require&&null==this._&&(global._=require("underscore")),n=!1,t="object array null undefined".split(" "),o=function(r,e){var l,o,f,g,p,d;return null==e&&(e=!1),o=[],p=null,g=function(n,t){return _.compact([n,t]).join(".")},d=function(n){var t,r,e;for(r=0,e=o.length;e>r;r++)t=o[r],s(n.path,null!=t?t.basepath:void 0)&&t.exec(n);return n},f=function(n,t,e,u){var l;if(l=i(r,n,t,e)){if(u)return;return p=l.path,d(l),p=null,c.clear()}},(l=function(i,d){return null==d&&(d=!1),{path:i,get:function(n,t){var e,l;return 1===arguments.length&&"object"===a(n)&&(t=n,n=""),e=u(r,g(i,n)),l=a(e),"undefined"!==l&&"null"!==l||null==(null!=t?t.or:void 0)?(null!=t?t.clone:void 0)===!1?e:_.clone(e):t.or},set:function(n,r,e,u){var l,o;if(null==e&&(e=!1),null==u&&(u=!1),d)return console.warn("You're trying to set data on a readonly cursor!"),this;if("string"!==(o=a(n))){if(!(h.call(t,o)>=0))return console.warn("The first parameter to .set() is an invalid type:",o),this;u=e,e=r,r=n,n=""}return l=g(i,n),null!=p&&s(n,p)&&c("You're making changes in the same path ("+n+") within an onChange handler. This can lead to infinite loops, be careful."),f(l,r,e,u),this},map:function(n,t){var r,e,u,l,o,i,s,c;switch(t=arguments[arguments.length-1],u=arguments.length>1?this.get(arguments[0]):this.get(),t||(t=function(n){return n}),a(u)){case"array":for(s=[],r=o=0,i=u.length;i>o;r=++o)l=u[r],s.push(t(l,r,u));return s;case"object":c=[];for(e in u)l=u[e],c.push(t(l,e,u));return c;case"null":case"undefined":return[];default:return[t(u)]}},hasChanged:function(n){var t;return null==n&&(n=""),null==p?!1:(t=g(i,n),s(p,t))},exists:function(n){var t;return null==n&&(n=""),t="*^%^*(*&!",this.get(n,{or:t})!==t},isEmpty:function(n){var t;return null==n&&(n=""),t=a(this.get(n)),"null"===t||"undefined"===t},isNotEmpty:function(n){return null==n&&(n=""),!this.isEmpty(n)},isNull:function(n){return null==n&&(n=""),"null"===a(this.get(n))},isMissing:function(n){return null==n&&(n=""),"undefined"===a(this.get(n))},cursor:function(n,t){var r;return r=g(i,n),e?l(r,!0):l(r,t)},listenerCount:function(n){var t;return null==n&&(n=!1),n===!0&&""===i?o.length:function(){var n,r,e;for(e=[],n=0,r=o.length;r>n;n++)t=o[n],t.cursor===this&&e.push(t);return e}.call(this).length},_listenerSummary:function(){var n,t,r,e,u,l,i,s,a,c,f,g,p;for(u={},l=0,i=0,a=o.length;a>i;i++)r=o[i],l+=1,t=u[f=r.basepath]||(u[f]={listeners:0,cursors:[]}),t.listeners+=1,g=r.cursor,h.call(t.cursors,g)<0&&t.cursors.push(r.cursor);for(n=[""+l+" listeners in ogre."],p=_.keys(u).sort(),s=0,c=p.length;c>s;s++)e=p[s],r=u[e],n.push("  "+(e||"<root>")+":"),n.push("    - listeners "+r.listeners),n.push("    -   cursors "+r.cursors.length);return n.join("\n")},onChange:function(t,r){var e;return n&&console.log(":cursor: start listening for changes",i||"<root>"),e=null!=r?g(i,r):i,o.push({exec:t,basepath:e,cursor:this}),this},stopListening:function(t){var r,e,u,l,s,a,c,h;if(null==t&&(t=!1),t===!0&&""===i)n&&console.log(":cursor: clearing all callbacks",i||"<root>"),o.length=0;else{for(u=[],e=l=0,a=o.length;a>l;e=++l)r=o[e],r.cursor===this&&u.push(e);for(n&&u.length>0&&console.log(":cursor: stop listening for changes",i||"<root>"),h=u.sort().reverse(),s=0,c=h.length;c>s;s++)e=h[s],o.splice(e,1)}return this},stopListeningAt:function(t){var r,e,u,l,a,c,h,f;if(null==t||_.isEmpty(t))n&&console.warn("You must specify a path to stop listening to.");else{for(g(i,t),u=[],e=l=0,c=o.length;c>l;e=++l)r=o[e],s(t,r.basepath)&&u.push(e);for(n&&u.length>0&&console.log(":cursor: stop listening for changes at",fullpath),f=u.sort().reverse(),a=0,h=f.length;h>a;a++)e=f[a],o.splice(e,1)}return this},dispose:function(){return this.stopListening(""===i)}}})("",e)},r=function(n,t,r){return{path:n,value:t,oldValue:r}},c=function(){var n,t;return t=0,n=function(n){return 0===t&&console.warn(n),t+=1},n.clear=function(){return t=0},n}(),e=function(n){return _.compact(n.split("."))},u=function(n,t,r){var u,l,o;for(null==t&&(t=""),null==r&&(r=!1),o=e(t),l=n;null!=l&&o.length;)u=o.shift(),l[u]||r===!0&&(l[u]={}),l=l[u];return l},i=function(n,t,o,i){var s,a,c,h,f;if(null==t&&(t=""),f=e(t),c=f.pop(),s=f.length?u(n,f.join("."),!0):n,_.isEqual(s[c],o))return!1;if(a=s[c],i!==!0&&l(o)){if(h=_.extend(_.clone(a||{}),o),_.isEqual(a,h))return!1;s[c]=h,o=h}else s[c]=o;return r(t,o,a)},a=function(){var n,t,r,e,u,l,o;for(o=Object.prototype.toString,t=/\[object HTML(.*)\]/,n={},l="Array Boolean Date Function NodeList Null Number RegExp String Undefined ".split(" "),e=0,u=l.length;u>e;e++)r=l[e],n["[object "+r+"]"]=r.toLowerCase();return function(r){var e,u;return u=o.call(r),(e=n[u])?e:(e=u.match(t))?e[1].toLowerCase():"object"}}(),l=function(n){return"object"===a(n)},s=function(n,t){return""===t?!0:null===n||null===t?!1:(n=String(n),t=String(t),n.length>=t.length&&n.slice(0,t.length)===t)},"undefined"!=typeof module&&null!==module?module.exports=o:this.ogre=o}).call(this);